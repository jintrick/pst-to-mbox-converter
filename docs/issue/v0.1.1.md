# Issue v0.1.1: テストコードのリファクタリングと堅牢性の向上

## 前提知識
- spec.md
- docs/issue/v0.1.md

## 現状の問題点

`tests/test_conversion.py` に実装されたテストは機能していますが、いくつかの点で改善の余地があります。

1.  **リソース管理が不完全:** `PSTReader` や `MboxWriter` のインスタンスを手動で `.close()` しています。テスト内のアサーションが失敗した場合、`.close()` が呼ばれずにファイルハンドルが開いたままになる可能性があります。
2.  **テストの検証が不正確:**
    - `test_end_to_end_conversion` では、生成されたMBOXファイルにメッセージが「1つ以上あること」しか確認していません。これでは、一部のメッセージが欠落していてもテストが成功してしまいます。
    - `test_mbox_writer_adds_message` では、生成されたファイルを生のテキストとして読み込み、文字列が含まれるかを確認しています。これは不安定な方法であり、より信頼性の高い検証方法があります。

## 解決策の概要

`tests/test_conversion.py` をリファクタリングし、テストの信頼性と保守性を向上させます。具体的には、`with` ステートメントを導入してリソース管理を徹底し、アサーションをより厳密なものに修正します。

## 解決策の詳細

1.  **`with` ステートメントの導入:**
    - `PSTReader` や `MboxWriter` をインスタンス化しているすべてのテスト関数を修正し、`with` ステートメントを使用してください。これにより、テストの成功・失敗にかかわらず、ファイルリソースが自動的かつ確実に解放されるようになります。

2.  **アサーションの厳密化:**
    - `test_end_to_end_conversion` を修正し、`sample.pst` に含まれる**正確なメッセージ数**を検証するようにしてください。（例: `sample.pst` に3件のメールが含まれる場合、生成されたMBOXファイルにも3件のメッセージが含まれることをアサートする）
    - `test_mbox_writer_adds_message` を修正し、ファイルの内容を文字列検索するのではなく、`mailbox` ライブラリを使ってMBOXファイルを再度読み込み、メッセージの数や内容が正しいかを検証するようにしてください。

## 参考とすべきスクリプト等

以下の差分を参考に、`tests/test_conversion.py` を修正してください。

```diff
--- a/tests/test_conversion.py
+++ b/tests/test_conversion.py
@@ -12,49 +12,41 @@
 
 def test_pst_reader_opens_file():
     """Tests that PSTReader can successfully open a PST file."""
-    try:
-        reader = PSTReader(SAMPLE_PST_PATH)
-        reader.close()
-    except Exception as e:
-        pytest.fail(f"PSTReader failed to open the PST file: {e}")
+    # The 'with' statement ensures the file is closed even if assertions fail
+    with PSTReader(SAMPLE_PST_PATH) as reader:
+        assert reader.pst_file is not None
+        assert reader.root_folder is not None
 
 def test_pst_reader_get_messages_yields_bytes():
     """Tests that get_messages yields non-empty bytes."""
-    reader = PSTReader(SAMPLE_PST_PATH)
-    messages = list(reader.get_messages())
-    reader.close()
+    with PSTReader(SAMPLE_PST_PATH) as reader:
+        messages = list(reader.get_messages())
 
     assert len(messages) > 0, "No messages were extracted from the PST file."
     for msg in messages:
         assert isinstance(msg, bytes), f"Message should be bytes, but got {type(msg)}."
         assert len(msg) > 0, "Message bytes should not be empty."
 
 def test_mbox_writer_adds_message(tmp_path):
     """Tests that MboxWriter can add a message to an MBOX file."""
     mbox_file = tmp_path / "test.mbox"
-    writer = MboxWriter(str(mbox_file))
-    writer.add_message(VALID_MESSAGE_BYTES)
-    writer.close()
+    with MboxWriter(str(mbox_file)) as writer:
+        writer.add_message(VALID_MESSAGE_BYTES)
 
     assert os.path.exists(mbox_file)
-    with open(mbox_file, "r") as f:
-        content = f.read()
-        assert "Subject: Test" in content
+    mbox = mailbox.mbox(mbox_file)
+    assert len(mbox) == 1
+    assert "Subject: Test" in mbox[0].as_string()
 
 def test_mbox_writer_handles_none_message(tmp_path, caplog):
     """Tests that MboxWriter logs a warning for None messages."""
     mbox_file = tmp_path / "test.mbox"
-    writer = MboxWriter(str(mbox_file))
-    writer.add_message(None)
-    writer.close()
+    with MboxWriter(str(mbox_file)) as writer:
+        writer.add_message(None)
 
     assert "Attempted to add an empty message. Skipping." in caplog.text
     assert any(record.levelno == 30 for record in caplog.records) # 30 is WARNING
 
 def test_mbox_writer_handles_corrupted_message(tmp_path, caplog, monkeypatch):
     """Tests that MboxWriter logs an error for corrupted messages."""
-
     def mock_message_from_bytes(b, *, policy=None):
         raise ValueError("Simulated parsing error")
 
@@ -62,9 +54,8 @@
 
     mbox_file = tmp_path / "test.mbox"
-    writer = MboxWriter(str(mbox_file))
-    writer.add_message(b"any bytes will now cause an error")
-    writer.close()
+    with MboxWriter(str(mbox_file)) as writer:
+        writer.add_message(b"any bytes will now cause an error")
 
     assert "Failed to parse and add message to MBOX" in caplog.text
     assert "Simulated parsing error" in caplog.text
@@ -80,7 +71,7 @@
         ["pst-converter", "--input", SAMPLE_PST_PATH, "--output", str(output_mbox)]
     )
 
-    # I'll mock sys.exit to prevent the test runner from exiting
+    # Mock sys.exit to prevent the test runner from exiting
     def mock_exit(status):
         pass
     monkeypatch.setattr(sys, "exit", mock_exit)
@@ -93,5 +84,10 @@
     assert output_mbox.stat().st_size > 0
 
     # For a more thorough check, we can use the mailbox library to count messages
+    # We should also know how many messages are in the sample.pst to make a precise assertion.
+    # Let's assume sample.pst contains 3 messages for this example.
+    # You should adjust this number to the actual count in your sample.pst.
+    expected_message_count = 3 # <-- ADJUST THIS
     mbox = mailbox.mbox(output_mbox)
-    assert len(mbox) > 0
+    assert len(mbox) == expected_message_count, f"Expected {expected_message_count} messages, but found {len(mbox)}"
```

## テスト方法
プロジェクトのルートディレクトリで `pytest` コマンドを実行し、すべてのテストが成功することを確認してください。

## マージ先ブランチ
このIssueのPRは `develop/0.1.1` ブランチに向けて作成してください。